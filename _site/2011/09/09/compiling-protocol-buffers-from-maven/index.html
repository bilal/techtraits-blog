
<!doctype html>  
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]--> 
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]--> 
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]--> 
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]--> 
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]--> 
<head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
 
  <title>Compiling Protocol Buffers from Maven</title> 
  <meta name="author" content="Name Lastname" />
  <link href='http://fonts.googleapis.com/css?family=Lato:light,regular,bold'
  rel='stylesheet' type='text/css'>
  <link href="/assets/themes/jamesyu/css/
reset.css" media="screen" rel="stylesheet" type="text/css" /> 
  <link href="/assets/themes/jamesyu/css/highlight.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/assets/themes/jamesyu/css/main.css" media="screen" rel="stylesheet" type="text/css" /> 
  <link rel="alternate" type="application/rss+xml" href="/atom.xml" title="RSS feed">
</head> 
 
    <body> 
        <div id="header">
            <div class="inner">
                <ul>
                    <li><a href="http://twitter.com/username">Follow Me</a></li>
                    <li><a href="/about.html">About Me</a></li>
                </ul>
                <h1><a href="/">Name Lastname</a></h1>
                <h2></h2>
            </div>
        </div>
                
        <div id="content">
            <div class="inner">
                
<div class="post">
    <h3><a href="">Compiling Protocol Buffers from Maven</a></h3>
  
    <div class="body">
        <p style='text-align: justify;'><a href='http://code.google.com/p/protobuf/' target='_blank' title='Protocol Buffer'>Protocol buffer</a> is a technology made by google for automatic serialization of data to and from a compressed binary format. Essentially you define your data in a <strong>I</strong>nterface <strong>D</strong>efinition <strong>L</strong>anguage <a href='http://en.wikipedia.org/wiki/IDL_%28programming_language%29' target='_blank' title='IDL'>(IDL)</a> and then generate bindings for any language from which you want to generate the data or consume data. It is very similar to <a href='http://thrift.apache.org/' target='_blank' title='Thrift'>Thrift</a> in philosophy and function except that Thrift provides network transport as well as serialization.</p><!--more--><p style='text-align: justify;'>As with all code generation frameworks the first problem we need to tackle is how to efficiently integrate the code generation into our build pipeline. There some important requirements for such an integration. First, the generated code should not be checked in manually or if possible it should not be checked in at all as this will lead to frustration later. Developers will forget to checking generated files, overwrite each others' changes as generate code tends to be verbose and unfamiliar to the user. Second, the generated code should be available for debugging otherwise development around the generated code will be frustrating and slow. Third, incompatible changes to the source IDL files should break the build. Last, people who do not need to edit the IDL files should not have to generate the code locally as this will be another piece of tech they will maintain.</p><p style='text-align: justify;'>To support all of these requirements I use a <a href='http://maven.apache.org/' target='_blank' title='Maven'>Maven</a> based build pipeline with a <a href='http://nexus.sonatype.org/' target='_blank' title='Nexus Sonatype'>Nexus Sonatype repository</a> for storing artifacts which can then be used for all developers in their local builds. This tutorial will give a step by step guide to setting up such a project. Note this tutorial is only compatible with Linix/Unix systems or cygwin if you are on windows</p><h3 style='text-align: justify;'>Tools of the trade</h3>
<p>Before going further you will need to install the following tools. <strong>Java 6 SDK. </strong>The first step is to download and install Java from <a href='http://www.java.com/en/download/' target='_blank' title='http://www.java.com/en/download/'>http://www.java.com/en/download/</a> in this tutorial we will be generating code for Java and C++. <strong>Maven 3.</strong> Next we download and install Apache Maven 3 from <a href='http://maven.apache.org/download.html' target='_blank' title='http://maven.apache.org/download.html'>http://maven.apache.org/download.html</a>. The installation process is simple enough and I won&#8217;t get into the details. Please feel free to ask questions in the comments or the forum if you get stuck.&lt;/p&gt;</p>
<pre lang='bash'>#Run this command to check the correct version of Maven is installed, in the path
$mvn  --version
#It should echo the following line among other output.
Apache Maven 3.X.X ....</pre><p style='text-align: justify;'><strong>Nexus Repository.</strong>You will need to setup a nexus repository in order to share the packaged, generated sources between developers. I have created a simple tutorial on setting up a Nexus repository. <a href='http://www.techtraits.ca/?p=315' target='_blank' title='Setting up Nexus Repository '>Here</a></p><p style='text-align: justify;'><strong>Protocol Buffer Compiler.</strong> You will need to install the protocol buffer compiler which can be downloaded <a href='http://protobuf.googlecode.com/files/protobuf-2.4.1.tar.bz2' title='http://protobuf.googlecode.com/files/protobuf-2.4.1.tar.bz2'>here</a>. Detailed installation instructions for the protocol buffer compiler can be found <a href='http://code.google.com/p/protobuf/source/browse/trunk/INSTALL.txt' target='_blank' title='http://code.google.com/p/protobuf/source/browse/trunk/INSTALL.txt'>here</a>. However, the basic steps are to untar the package, browse to the directory in the terminal or cygwin and run the following commands.</p><pre lang='bash'>./configure
make
sudo make install
protoc --version</pre><p style='text-align: justify;'><strong>Maven Protoc Plugin</strong>In order to compile protocol buffer you would need to compile and install the Maven Protoc Plugin (Full disclosure: I am a contributor to the plugin). The source is available on github at <a href='https://github.com/usmanismail/maven-protoc-plugin' target='_blank' title='https://github.com/usmanismail/maven-protoc-plugin'>https://github.com/usmanismail/maven-protoc-plugin</a> or you can download the source <a href='http://www.techtraits.ca/wp-content/uploads/2011/09/maven-protoc-plugin.zip'>here</a>. Unzip the package and run the following commands to compile the plugin</p><pre lang='bash'>
cd maven-protoc-plugin
mvn clean install
</pre>
<p>&#160; <h3>Creating maven project</h3> <p style='text-align: justify;'>We will be keeping our protocol buffer IDL files in a maven project which will be deployed to the Nexus repository we just setup. We keep our IDL files a little maven project of its own so to ensure the four requirements for integration that we specified in the start of this tutorial. I will highlight how we fulfill each requirement as we go. To create a simple Maven java project run the following command:</p></p>
<pre lang='bash'>mvn archetype:generate \
  -DgroupId=com.flybynight.protobuff \
  -DartifactId=protocompiler \
  -DarchetypeArtifactId=java-1.6-archetype  \
  -DarchetypeVersion=0.0.2  \
  -DarchetypeGroupId=net.avh4.mvn.archetype \
  -Dversion=1.0-SNAPSHOT</pre><p style='text-align: justify;'>This will create a base project for you called "protocompiler" if you cd to the newly created directory you should be able to see that it already contains a src folder and a pom.xml file.</p><pre lang='bash'>cd protoccompiler
ls -l
-rw-r--r--  1 usman  staff  1637  5 Sep 19:02 pom.xml
drwxr-xr-x  4 usman  staff   136  5 Sep 19:02 src</pre>
<p>&#160; <h3>Writing your Proto Files</h3> <p style='text-align: justify;'>cd to src/main/resources and create a new file called hello.proto and add the following text:</p></p>
<pre lang='proto'>message HelloWorld {
  required string message = 1;
}</pre>
<p>We can test out protocol buffer compiler installation and that our file is valid by running the command shown below. It will generate the Hello.java file. <pre lang='bash'>protoc -I=./ --java_out=./ hello.proto
ls -l</pre></p>
<h3>Generating Source Files</h3><pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: 
&lt;p style=&quot;text-align: justify;&quot;&gt;
Now we get to the automatic generation of the source files which we do using the maven-protoc-plugin we installed earlier. Open the pom file at protoccompiler/pom.xml, look for the &quot;dependencies&quot; element and add the following dependency to pull in protocol buffer support files.

&lt;pre lang=&quot;xml&quot;&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;
    &lt;artifactId&gt;protobuf-java&lt;/artifactId&gt;
    &lt;version&gt;2.4.1&lt;/version&gt;
&lt;/dependency&gt;
&lt;/pre&gt;
&lt;p style=&quot;text-align: justify;&quot;&gt;
Now look for the &quot;plugins&quot; element and add the plugin definition below. We are invoking the &quot;maven-protoc-plugin&quot; that we compiled earlier in the tutorial by specifying its groupId and artifactId. In the configuration section we are specifying the protocol buffer compiler binary using &quot;protocExecutable&quot;. Note that this assumes that protoc is in the path. If this is not the case you can specify the fully qualified path to the binary. Using &quot;protoSourceRoot&quot; we are specifying the location of the proto files. The plugin looks for files in the specified directory with the &quot;.proto&quot; extension. We are then specifying that we wish to generate sources for Java and C++ using the &quot;JAVA&quot; and &quot;CPP&quot; constants respectively. For each language we also specify a output directory where the generated source will be placed.
&lt;pre lang=&quot;xml&quot;&gt;
&lt;plugin&gt;
    &lt;groupId&gt;com.google.protobuf.tools&lt;/groupId&gt;
    &lt;artifactId&gt;maven-protoc-plugin&lt;/artifactId&gt;
    &lt;version&gt;0.1.11-SNAPSHOT&lt;/version&gt;
    &lt;configuration&gt;
        &lt;protocExecutable&gt;protoc&lt;/protocExecutable&gt;
        &lt;protoSourceRoot&gt;${project.basedir}/src/main/resources/&lt;/protoSourceRoot&gt;
        &lt;languageSpecifications&gt;
            &lt;LanguageSpecification&gt;
                &lt;language&gt;JAVA&lt;/language&gt;
                &lt;outputDirectory&gt;${project.basedir}/target/generated-sources/java&lt;/outputDirectory&gt;
            &lt;/LanguageSpecification&gt;
	    &lt;LanguageSpecification&gt;
	        &lt;language&gt;CPP&lt;/language&gt;
	        &lt;outputDirectory&gt;${project.basedir}/target/generated-sources/cpp&lt;/outputDirectory&gt;
	    &lt;/LanguageSpecification&gt;
        &lt;/languageSpecifications&gt;						
    &lt;/configuration&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;goals&gt;
                &lt;goal&gt;compile&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
&lt;/pre&gt;
&lt;p style=&quot;text-align: justify;&quot;&gt;
Once you make the changes save the pom file and compile the project using the mvn clean install command. You should see the generated sources in target/generated-sources/java and target/generated-sources/cpp. Furthermore the generated jar file contains the generated java sources as compiled class files. This fulfills our first requirement that the generated files should not have to be checked in (as they will be available in the jar file). 

&lt;h3&gt;Attach source&lt;/h3&gt;
&lt;p style=&quot;text-align: justify;&quot;&gt;
To fulfill our requirement of generated code being easy to debug we will attach a source jar to our artifact. We can do this by adding the maven source plugin to our pom file as shown below.
&lt;pre lang=&quot;xml&quot;&gt;
&lt;plugin&gt;
	&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
	&lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt;
	&lt;version&gt;2.1.2&lt;/version&gt;
	&lt;executions&gt;
		&lt;execution&gt;
			&lt;id&gt;attach-sources&lt;/id&gt;
			&lt;goals&gt;
				&lt;goal&gt;jar&lt;/goal&gt;
			&lt;/goals&gt;
		&lt;/execution&gt;
	&lt;/executions&gt;
&lt;/plugin&gt;
&lt;/pre&gt;

&lt;h3&gt;Deploying to Nexus&lt;/h3&gt;
&lt;p style=&quot;text-align: justify;&quot;&gt;
To ensure our last two requirements of breaking the build for incompatible changes but not requiring everyone to build locally we need to deploy our code to the nexus repository. To do this we will create a settings.xml with the data shown below and run &lt;strong&gt;mvn clean install --settings ./settings.xml&lt;/strong&gt;.
&lt;pre lang=&quot;xml&quot;&gt;
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;settings xmlns=&quot;http://maven.apache.org/SETTINGS/1.0.0&quot; 
          xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; 
          xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;&gt;
&lt;servers&gt;
    &lt;server&gt;
      &lt;id&gt;myNexusRepo&lt;/id&gt;
      &lt;username&gt;admin&lt;/username&gt;
      &lt;password&gt;admin123&lt;/password&gt;
    &lt;/server&gt;
&lt;/servers&gt;
&lt;/settings&gt;
&lt;/pre&gt;

&lt;h3&gt;Pulling from nexus&lt;/h3&gt;
Now we can just setup a maven project to pull in the generated code by adding the dependency shown below. This fulfills our last two requirements, if there is an incompatible change it will break the build for the dependent project without requiring people to build proto files themselves.  

&lt;pre lang=&quot;xml&quot;&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.flybynight.protobuff&lt;/groupId&gt;
    &lt;artifactId&gt;protocompiler&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;
&lt;/pre&gt;</pre>
    </div>
    
    <div class="meta">    
        <ul>
          Published: 09 Sep 2011<br/>
        </ul>
	<ul class="list-category list-linear">
	  <li class="list-head">category: </li>
			
			


  
    
  


	</ul>
	<ul class="list-tag list-linear">
		<li class="list-head">tags: </li>
			
			


  
    
  



	</ul>
    </div>

    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    var disqus_identifier = '289 http://username.github.com/?p=289';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




</div>


            </div>
        </div>
        
        <div id="footer" class="clearfix">
            <div class="inner">
                <div class="archives">
                    <h3>Archives</h3>
            
                    <table>
                    
                        <tr>
                            <td class="date">10 Mar 2012</td>
                            <td><a href="/2012/03/10/jackson-optimization-using-non-default-for-fun-and-profit">Jackson Optimization, Using Non-Default for fun and profit</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">14 Feb 2012</td>
                            <td><a href="/2012/02/14/really-really-async-aws-sdk">Really Really Async AWS SDK</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">11 Feb 2012</td>
                            <td><a href="/2012/02/11/erlang-list-manipulation-using-comprehensions">Erlang: List Manipulation using comprehensions</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">03 Feb 2012</td>
                            <td><a href="/2012/02/03/java-optimizaiton">Java Optimizaiton, Why is my application so slow?</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">17 Jan 2012</td>
                            <td><a href="/2012/01/17/regular-expressions-in-elipse-find">Regular Expressions in Elipse Find</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">16 Jan 2012</td>
                            <td><a href="/2012/01/16/capturing-java-stack-strace-using-jstack">Capturing Java Stack Strace Using JStack</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">17 Dec 2011</td>
                            <td><a href="/2011/12/17/creating-executable-jars-with-maven">Creating executable jars with Maven</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">04 Dec 2011</td>
                            <td><a href="/2011/12/04/custum-pmd-rule-for-private-injected-fields">Custom PMD Rule for Private Injected fields</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">27 Nov 2011</td>
                            <td><a href="/2011/11/27/using-method-interceptors-with-guice">Using method interceptors with Guice</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">20 Nov 2011</td>
                            <td><a href="/2011/11/20/using-custom-serializers-with-jackson">Using Custom Serializers with Jackson</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">05 Nov 2011</td>
                            <td><a href="/2011/11/05/custom-pmd-rules-using-xpath">Custom PMD Rules using XPath</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">31 Oct 2011</td>
                            <td><a href="/2011/10/31/writting-pretty-code-with-pmd">Writing pretty code with PMD</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">31 Oct 2011</td>
                            <td><a href="/2011/10/31/thanks-i-needed-that">Thanks, I needed that</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">16 Oct 2011</td>
                            <td><a href="/2011/10/16/jsonkit">iPhone SDK: Integrating with Json using Jsonkit</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">10 Oct 2011</td>
                            <td><a href="/2011/10/10/iphonesdk-nsuserdefaults">iPhoneSDK: NSUserDefaults</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">02 Oct 2011</td>
                            <td><a href="/2011/10/02/using-cachedump-to-debug-memcached">Using cachedump to debug memcached</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">02 Oct 2011</td>
                            <td><a href="/2011/10/02/iphone-sdk-tabbars">IPhone SDK: TabBars</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">09 Sep 2011</td>
                            <td><a href="/2011/09/09/compiling-protocol-buffers-from-maven">Compiling Protocol Buffers from Maven</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">05 Sep 2011</td>
                            <td><a href="/2011/09/05/running-nexus-sontaype-over-jetty">Running Nexus Sontaype over Jetty</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">12 Aug 2011</td>
                            <td><a href="/2011/08/12/implementing-jackson-views">Implementing Jackson Views</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">27 Jul 2011</td>
                            <td><a href="/2011/07/27/polymorphic-json-serialization-using-jackson">Polymorphic JSON Serialization using Jackson</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">25 Jun 2011</td>
                            <td><a href="/2011/06/25/five-minute-guide-to-setting-up-a-java-webserver">Setting up a webservice using Guice & Sitebricks</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">12 Jun 2011</td>
                            <td><a href="/2011/06/12/iphone-sdk-hello-world">IPhone SDK Hello World</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">12 Jun 2011</td>
                            <td><a href="/2011/06/12/iphone-sdk-hello-world">IPhone SDK Hello World</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">11 Jun 2011</td>
                            <td><a href="/2011/06/11/records-in-erlang">Records in erlang</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">11 Jun 2011</td>
                            <td><a href="/2011/06/11/records-in-erlang">Records in erlang</a></td>
                        </tr>
                    
                    </table>
                </div>
                <div class="about">
                    <h3><a href="/about.html">About Me</a></h3>
                    
                    <a href="/about.html"><img src="/assets/themes/jamesyu/images/me_small.png" alt="ME" /></a>
                    <div>
                        This is yet a short description of myself. Try to keep it short. <a href="/about.html">Read more</a>
                    </div>
                </div>
            </div>
        </div>
        
    </body> 
</html>

